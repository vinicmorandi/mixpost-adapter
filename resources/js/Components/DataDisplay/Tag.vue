<script setup>
import {inject, nextTick, ref} from "vue";
import { useI18n } from "vue-i18n";
import {router} from "@inertiajs/vue3";
import useNotifications from "@/Composables/useNotifications";
import {lightOrDark} from "@/helpers";
import {colorLight, colorDark} from "@/Constants/ColorPallet";
import Dropdown from "@/Components/Dropdown/Dropdown.vue"
import DropdownItem from "@/Components/Dropdown/DropdownItem.vue"
import ColorPicker from "@/Components/Package/ColorPicker.vue";
import DialogModal from "@/Components/Modal/DialogModal.vue";
import ConfirmationModal from "@/Components/Modal/ConfirmationModal.vue";
import PrimaryButton from "@/Components/Button/PrimaryButton.vue"
import SecondaryButton from "@/Components/Button/SecondaryButton.vue"
import DangerButton from "@/Components/Button/DangerButton.vue"
import Preloader from "@/Components/Util/Preloader.vue";
import EllipsisHorizontalIcon from "@/Icons/EllipsisHorizontal.vue"
import XIcon from "@/Icons/X.vue"
import PencilSquareIcon from "@/Icons/PencilSquare.vue";
import SwatchIcon from "@/Icons/Swatch.vue";
import TrashIcon from "@/Icons/Trash.vue";

const { t: $t } = useI18n()

const workspaceCtx = inject('workspaceCtx');

defineEmits(['remove']);

const props = defineProps({
    item: {
        type: Object,
        required: true
    },
    removable: {
        type: Boolean,
        default: true
    },
    editable: {
        type: Boolean,
        default: true
    }
})

const {notify} = useNotifications();

const badgeClass = 'min-w-[48px] px-2 rounded-md';

// Rename
const rename = ref(false);
const renameRef = ref(null);
const renameText = ref('');
const isRenaming = ref(false);

const openRename = () => {
    rename.value = true;
    renameText.value = props.item.name;

    nextTick(() => {
        renameRef.value.focus();
    })
}

const closeRename = () => {
    rename.value = false;
    renameText.value = ''
}

const renameTag = () => {
    if (props.item.name === renameText.value) {
        closeRename();
        return;
    }

    router.put(route('mixpost.tags.update', {workspace: workspaceCtx.id, tag: props.item.uuid}), {
        action: 'name',
        name: renameText.value
    }, {
        onStart() {
            isRenaming.value = true
        },
        onFinish() {
            isRenaming.value = false;
            closeRename();
        }
    })
}

// Change color
const changeColorModal = ref(false);
const changeColorHex = ref('');
const isColorChanging = ref(false);

const openChangeColorModal = () => {
    changeColorModal.value = true;
    changeColorHex.value = props.item.hex_color;
}

const closeChangeColorModal = () => {
    changeColorModal.value = false;
    changeColorHex.value = '';
}

const changeTagColor = () => {
    router.put(route('mixpost.tags.update', {workspace: workspaceCtx.id, tag: props.item.uuid}), {
        action: 'color',
        hex_color: changeColorHex.value,
    }, {
        onStart() {
            isColorChanging.value = true
        },
        onFinish() {
            isColorChanging.value = false;
            closeChangeColorModal();
        }
    })
}

// Delete
const confirmationTagDeletion = ref(false);
const isDeleting = ref(false);

const deleteTag = () => {
    router.delete(route('mixpost.tags.delete', {workspace: workspaceCtx.id, tag: props.item.uuid}), {
        onStart() {
            isDeleting.value = true;
        },
        onSuccess() {
            confirmationTagDeletion.value = false;
            notify('success', $t('tag.label_deleted'));
        },
        onFinish() {
            isDeleting.value = false;
        },
    })
}
</script>
<template>
    <div>
        <div
            :style="{backgroundColor: item.hex_color, color: lightOrDark(item.hex_color) === 'light' ? colorDark : colorLight}"
            :class="badgeClass"
            class="relative group">
            <Preloader v-if="isRenaming" size="sm" :opacity="50"/>

            <div
                v-if="removable || editable"
                :style="{backgroundColor: item.hex_color}"
                class="tag-actions absolute right-0 top-0 h-full pl-0.5 hidden items-center rounded-r-md group-hover:flex">
                <template v-if="editable">
                    <Dropdown width-classes="w-48">
                        <template #trigger>
                            <div tabindex="0" role="button" class="group-btn">
                                <EllipsisHorizontalIcon class="!w-5 !h-5 opacity-75 [.group-btn:hover_&]:opacity-100"/>
                            </div>
                        </template>

                        <template #content>
                            <DropdownItem @click="openRename" as="button">
                                <PencilSquareIcon class="!w-5 !h-5 mr-1"/>
                                {{ $t("general.rename") }}
                            </DropdownItem>

                            <DropdownItem @click="openChangeColorModal" as="button">
                                <SwatchIcon class="!w-5 !h-5 mr-1"/>
                                {{ $t("tag.change_color") }}
                            </DropdownItem>

                            <DropdownItem @click="confirmationTagDeletion = true" as="button">
                                <TrashIcon class="!w-5 !h-5 mr-1 text-red-500"/>
                                {{ $t("general.delete") }}
                            </DropdownItem>
                        </template>
                    </Dropdown>
                </template>

                <div v-if="removable" @click="$emit('remove')" tabindex="0" role="button" class="ml-1 group-btn">
                    <XIcon class="!w-5 !h-5 opacity-75 [.group-btn:hover_&]:opacity-100"/>
                </div>
            </div>

            <div v-if="!rename">
                {{ item.name }}
            </div>

            <div v-if="rename" class="relative">
                <input ref="renameRef"
                       v-model="renameText"
                       @keyup.enter="renameTag"
                       @blur="closeRename"
                       class="p-0 w-auto outline-none focus:outline-0 focus:outline-none border-none bg-transparent rounded-md"/>
            </div>
        </div>

        <template v-if="editable">
            <DialogModal :show="changeColorModal" max-width="md" @close="closeChangeColorModal">
                <template #header>
                    {{ $t("tag.change_label_color") }}
                </template>
                <template #body>
                    <template v-if="changeColorModal" class="flex flex-col">
                        <div
                            :style="{backgroundColor: changeColorHex, color: lightOrDark(changeColorHex) === 'light' ? colorDark : colorLight}"
                            :class="badgeClass" class="w-fit">{{ item.name }}
                        </div>
                        <div class="mt-4">
                            <ColorPicker v-model="changeColorHex"/>
                        </div>
                    </template>
                </template>
                <template #footer>
                    <SecondaryButton @click="closeChangeColorModal" :disabled="isColorChanging" class="mr-xs">{{ $t('general.cancel') }}
                    </SecondaryButton>
                    <PrimaryButton @click="changeTagColor" :is-loading="isColorChanging"
                                   :disabled="isColorChanging">{{ $t('general.save_changes')}}
                    </PrimaryButton>
                </template>
            </DialogModal>
            <ConfirmationModal :show="confirmationTagDeletion" variant="danger"
                               @close="confirmationTagDeletion = false">
                <template #header>
                    {{ $t("tag.delete_label") }}
                </template>
                <template #body>
                    {{ $t('tag.confirm_label_delete', {name: item.name}) }}
                </template>
                <template #footer>
                    <SecondaryButton @click="confirmationTagDeletion = false" :disabled="isDeleting" class="mr-xs">
                        {{ $t('general.cancel') }}
                    </SecondaryButton>
                    <DangerButton @click="deleteTag" :is-loading="isDeleting"
                                  :disabled="isDeleting"> {{ $t("general.delete") }}
                    </DangerButton>
                </template>
            </ConfirmationModal>
        </template>
    </div>
</template>
